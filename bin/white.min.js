var White={selector:"img",brightness:33,contrast:50,black_threshold:40,white_threshold:255,images:[],origin:window.location.origin,proxy:["http://cors-anywhere.herokuapp.com/","http://crossorigin.me/","http://cors.io/?u="],proxy_index:0,loadLeft:0,run:function(t){if(this.proxy_index=0,this.loadLeft=0,this.selector=t||this.selector,this.factor=259*(this.contrast+255)/(255*(259-this.contrast)),0==this.loadLeft){this.initImages();for(var e in this.images)this.applyToImage(this.images[e],!1)}},restore:function(t){var e=document.querySelectorAll(t);for(var i in e)this.restoreImage(e[i])},initImages:function(){this.images=[];var t=document.querySelectorAll(this.selector);for(var e in t)if(void 0!=t[e].style&&"IMG"==t[e].tagName){this.images.push([t[e],t[e].dataset.src||t[e].src,[[t[e].width],[t[e].height]],t[e].style.visibility]);var i=this.images[this.images.length-1];i[0].style.visibility="hidden"}this.loadLeft=this.images.length},applyToImage:function(t,e){var i=this,r=new Image;r.onload=function(){var e=t[0].naturalWidth||t[0].width,a=t[0].naturalHeight||t[0].height,s=document.createElement("canvas");s.width=e,s.height=a;var o=i.filterImage(t,r,e,a,s);console.log(o);var n=s.getContext("2d");n.putImageData(o,0,0);var h=s.toDataURL();void 0==t[0].dataset.src&&(t[0].dataset.src=t[0].src),t[0].src=h,t[0].style.visibility=t[3],i.loadLeft-=1},r.onerror=function(r,a,s){e===!0&&i.proxy_index===i.proxy.length-1?(i.loadLeft-=1,i.proxy_index=0,t[0].src=t[1]):e===!0&&i.proxy_index<i.proxy.length-1?(i.proxy_index+=1,i.applyToImage(t,!0)):i.applyToImage(t,!0)};var a;a=e?this.proxy[this.proxy_index]+t[1]:t[1],0!=a.indexOf(this.origin)&&(r.crossOrigin="Anonymous"),r.src=a},restoreImage:function(t){void 0!=t.dataset.src&&"IMG"==t.tagName&&(t.src=t.dataset.src)},filterImage:function(t,e,i,r,a){return this.filter(this.getPixels(t,e,i,r,a))},getPixels:function(t,e,i,r,a){if(t[4]&&t[4].dataset.pixels)return JSON.parse(t.dataset.pixels);var s=a.getContext("2d");s.fillStyle="#FFF",s.fillRect(0,0,a.width,a.height),s.globalCompositeOperation="luminosity",s.drawImage(e,0,0,a.width,a.height);var o=s.getImageData(0,0,a.width,a.height);return t[4]=o,o},filter:function(t){for(var e,i,r,a=t.data.length,s=0;s<a;s+=4)e=s,i=s+1,r=s+2,t.data[e]+=this.brightness,t.data[i]+=this.brightness,t.data[r]+=this.brightness,t.data[e]=this.factor*(t.data[e]-128)+128,t.data[i]=this.factor*(t.data[i]-128)+128,t.data[r]=this.factor*(t.data[r]-128)+128,t.data[e]<this.black_threshold&&(t.data[e]=this.black_threshold),t.data[i]<this.black_threshold&&(t.data[i]=this.black_threshold),t.data[r]<this.black_threshold&&(t.data[r]=this.black_threshold),t.data[e]>this.white_threshold&&(t.data[e]=this.white_threshold),t.data[i]>this.white_threshold&&(t.data[i]=this.white_threshold),t.data[r]>this.white_threshold&&(t.data[r]=this.white_threshold);return t}},QueryString=function(){for(var t={},e=document.currentScript.getAttribute("src").split("?")[1],i=e.split("&"),r=0;r<i.length;r++){var a=i[r].split("=");if("undefined"==typeof t[a[0]])t[a[0]]=decodeURIComponent(a[1]);else if("string"==typeof t[a[0]]){var s=[t[a[0]],decodeURIComponent(a[1])];t[a[0]]=s}else t[a[0]].push(decodeURIComponent(a[1]))}return t}();!function(t,e){"use strict";function i(){if(!s){s=!0;for(var t=0;t<a.length;t++)a[t].fn.call(window,a[t].ctx);a=[]}}function r(){"complete"===document.readyState&&i()}t=t||"docReady",e=e||window;var a=[],s=!1,o=!1;e[t]=function(t,e){return s?void setTimeout(function(){t(e)},1):(a.push({fn:t,ctx:e}),void("complete"===document.readyState||!document.attachEvent&&"interactive"===document.readyState?setTimeout(i,1):o||(document.addEventListener?(document.addEventListener("DOMContentLoaded",i,!1),window.addEventListener("load",i,!1)):(document.attachEvent("onreadystatechange",r),window.attachEvent("onload",i)),o=!0)))}}("docReady",window),QueryString.proxy&&(White.proxy=QueryString.proxy),QueryString.selector&&(White.selector=QueryString.selector),QueryString.brightness&&(White.brightness=parseInt(QueryString.brightness)),QueryString.contrast&&(White.contrast=parseInt(QueryString.contrast)),QueryString.black_threshold&&(White.black_threshold=parseInt(QueryString.black_threshold)),QueryString.white_threshold&&(White.white_threshold=parseInt(QueryString.white_threshold)),QueryString.selector&&(White.selector=QueryString.selector),"true"===QueryString.run&&docReady(function(){White.run()});
