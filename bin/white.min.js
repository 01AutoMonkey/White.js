var White={selector:"img",brightness:33,contrast:50,black_threshold:40,white_threshold:255,images:[],origin:window.location.origin,proxy:["http://crossorigin.me/","http://cors.io/?u="],proxy_index:0,loadLeft:0,run:function(t){if(this.proxy_index=0,this.loadLeft=0,this.selector=this.selector||t,0==this.loadLeft){this.initImages();for(var e in this.images)this.applyToImage(this.images[e],!1)}},restore:function(t){var e=document.querySelectorAll(t);for(var i in e)this.restoreImage(e[i])},initImages:function(){this.images=[];var t=document.querySelectorAll(this.selector);for(var e in t)if(void 0!=t[e].style&&"IMG"==t[e].tagName){this.images.push([t[e],t[e].dataset.src||t[e].src,[[t[e].width],[t[e].height]],t[e].style.visibility]);var i=this.images[this.images.length-1];i[0].style.visibility="hidden"}this.loadLeft=this.images.length},applyToImage:function(t,e){var i=this,r=new Image;r.onload=function(){var e=t[0].width,s=t[0].height,h=i.getCanvas(e,s),o=i.filterImage(r,e,s,h),n=h.getContext("2d");n.putImageData(o,0,0);var a=h.toDataURL();void 0==t[0].dataset.src&&(t[0].dataset.src=t[0].src),t[0].src=a,t[0].style.visibility=t[3],i.loadLeft-=1},r.onerror=function(r,s,h){e===!0&&i.proxy_index===i.proxy.length-1?(i.loadLeft-=1,i.proxy_index=0,t[0].src=t[1]):e===!0&&i.proxy_index<i.proxy.length-1?(i.proxy_index+=1,i.applyToImage(t,!0)):i.applyToImage(t,!0)};var s;s=e?this.proxy[this.proxy_index]+t[1]:t[1],0!=s.indexOf(this.origin)&&(r.crossOrigin="Anonymous"),console.log(s),r.src=s},restoreImage:function(t){void 0!=t.dataset.src&&"IMG"==t.tagName&&(t.src=t.dataset.src)},getCanvas:function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i},filterImage:function(t,e,i,r){return this.filter(this.getPixels(t,e,i,r))},getPixels:function(t,e,i,r){var s=r.getContext("2d");return s.fillStyle="#FFF",s.fillRect(0,0,r.width,r.height),s.globalCompositeOperation="luminosity",s.drawImage(t,0,0,r.width,r.height),s.getImageData(0,0,r.width,r.height)},filter:function(t){for(var e=t.data,i=0;i<e.length;i+=4)e[i]+=this.brightness,e[i+1]+=this.brightness,e[i+2]+=this.brightness;for(var r=259*(this.contrast+255)/(255*(259-this.contrast)),i=0;i<e.length;i+=4)e[i]=r*(e[i]-128)+128,e[i+1]=r*(e[i+1]-128)+128,e[i+2]=r*(e[i+2]-128)+128;for(var i=0;i<e.length;i+=4){var s=e[i],h=e[i+1],o=e[i+2];s<this.black_threshold&&(e[i]=this.black_threshold),h<this.black_threshold&&(e[i+1]=this.black_threshold),o<this.black_threshold&&(e[i+2]=this.black_threshold)}for(var i=0;i<e.length;i+=4){var s=e[i],h=e[i+1],o=e[i+2];s>this.white_threshold&&(e[i]=this.white_threshold),h>this.white_threshold&&(e[i+1]=this.white_threshold),o>this.white_threshold&&(e[i+2]=this.white_threshold)}return t}},QueryString=function(){for(var t={},e=document.currentScript.getAttribute("src").split("?")[1],i=e.split("&"),r=0;r<i.length;r++){var s=i[r].split("=");if("undefined"==typeof t[s[0]])t[s[0]]=decodeURIComponent(s[1]);else if("string"==typeof t[s[0]]){var h=[t[s[0]],decodeURIComponent(s[1])];t[s[0]]=h}else t[s[0]].push(decodeURIComponent(s[1]))}return t}();QueryString.proxy&&(White.proxy=QueryString.proxy),QueryString.selector&&(White.selector=QueryString.selector),QueryString.brightness&&(White.brightness=parseInt(QueryString.brightness)),QueryString.contrast&&(White.contrast=parseInt(QueryString.contrast)),QueryString.black_threshold&&(White.black_threshold=parseInt(QueryString.black_threshold)),QueryString.white_threshold&&(White.white_threshold=parseInt(QueryString.white_threshold)),QueryString.selector&&(White.selector=QueryString.selector),"true"===QueryString.run&&White.run();
